<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{{ post.title }} - lyricDisplay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('serve_dist_file', filename='reset.css') }}">
    <link rel="stylesheet" href="{{ url_for('serve_dist_file', filename='reveal.css') }}">
    <link rel="stylesheet" href="{{ url_for('serve_dist_file', filename='ldstyle.css') }}" id="theme">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">
            <!-- Ï†úÎ™© Ïä¨ÎùºÏù¥Îìú -->
            <section {% if post.background_image %}data-background="{{ url_for('serve_dist_file', filename=post.background_image.replace("dist/", "")) }}"{% endif %} data-background-color="#222">
                <div class="js-clock" style="text-align: left">
                    <h2>{{ post.created_at.strftime('%YÎÖÑ %mÏõî %dÏùº') }}</h2>
                    <h3>{{ post.title }}</h3>
                </div>
            </section>

            <!-- Ï∞¨Ïñë Ïä¨ÎùºÏù¥ÎìúÎì§ -->
            {% for song in post.songs %}
                {% if song.song_type == 'section' %}
                    <!-- Ï∞¨Ïñë Î™©Î°ù ÏÑπÏÖò -->
                    <section id="{{ song.section_title }}" {% if song.background_image %}data-background="{{ url_for('serve_dist_file', filename=song.background_image.replace("dist/", "")) }}"{% endif %}>
                        <h2>{{ song.section_title }}</h2>
                        <table>
                            <tbody>
                                <thead>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </thead>
                                <!-- Ïù¥ ÏÑπÏÖò Îí§Ïóê ÎÇòÏò¨ Ï∞¨ÏñëÎì§ÏùÑ ÎØ∏Î¶¨Î≥¥Í∏∞Î°ú ÌëúÏãú -->
                                {% set section_songs = [] %}
                                {% for next_song in post.songs[loop.index0 + 1:] %}
                                    {% if next_song.song_type == 'section' %}
                                        {% set _ = section_songs.append('BREAK') %}
                                    {% elif next_song.song_type in ['hymn', 'ccm'] and 'BREAK' not in section_songs %}
                                        {% set _ = section_songs.append(next_song) %}
                                    {% endif %}
                                {% endfor %}
                                {% for next_song in section_songs %}
                                    {% if next_song != 'BREAK' %}
                                        <tr>
                                            <th>{{ 'Ï∞¨ÏÜ°Í∞Ä' if next_song.song_type == 'hymn' else 'Ï∞¨ÏñëÍ≥°' }}</th>
                                            <th>{{ next_song.hymn_number + 'Ïû•' if next_song.hymn_number else '' }}</th>
                                            <th>{{ next_song.title }}</th>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </section>

                {% elif song.song_type == 'media' %}
                    <!-- ÎØ∏ÎîîÏñ¥ Ïä¨ÎùºÏù¥Îìú -->
                    {% if song.media_type == 'image' %}
                        <section data-background="{{ url_for('serve_dist_file', filename=song.media_url.replace("dist/", "")) }}" data-background-size="contain" data-background-color="#000">
                        </section>
                    {% elif song.media_type == 'video' %}
                        <section 
                            data-background-video="{{ url_for('serve_dist_file', filename=song.media_url.replace("dist/", "")) }}"
                            data-background-video-loop="true"
                            data-background-video-muted="true"
                            data-background-size="contain"
                            data-background-color="#000"
                            data-video-src="{{ url_for('serve_dist_file', filename=song.media_url.replace("dist/", "")) }}">
                            
                            <!-- ÎπÑÎîîÏò§ Ïª®Ìä∏Î°§ Î≤ÑÌäº -->
                            <div class="video-controls">
                                <button class="video-control-btn" onclick="toggleVideoSound(this)" title="ÏÜåÎ¶¨ ÏºúÍ∏∞/ÎÅÑÍ∏∞">
                                    <span class="muted-icon">üîá</span>
                                    <span class="unmuted-icon" style="display: none;">üîä</span>
                                </button>
                                <button class="video-control-btn" onclick="toggleVideoPlay(this)" title="Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ">
                                    <span class="play-icon">‚è∏</span>
                                    <span class="pause-icon" style="display: none;">‚ñ∂</span>
                                </button>
                            </div>
                        </section>
                    {% endif %}


                {% elif song.song_type == 'hymn' %}
                    <!-- Ï∞¨ÏÜ°Í∞Ä -->
                    <section id="{{ song.title }}">
                        {% if song.lyrics %}
                            {% set verses = song.lyrics.split('\n\n\n\n') %}
                            <!-- Ï†àÏàò Í≥ÑÏÇ∞: Ïà´Ïûê+Ï†àÎ°ú ÏãúÏûëÌïòÎäî Î∏îÎ°ùÏùò Í∞úÏàòÎ•º Î¶¨Ïä§Ìä∏Î°ú ÏàòÏßë (Ï§ëÎ≥µ Ï†úÍ±∞) -->
                            {% set verse_numbers = [] %}
                            {% for v in verses %}
                                {% set clean_verse = v.strip() %}
                                {% if clean_verse %}
                                    {% set first_line = clean_verse.split('\n')[0] %}
                                    {% if first_line and first_line.endswith('Ï†à') and first_line[:-1].isdigit() %}
                                        {% set verse_num = first_line[:-1]|int %}
                                        {% if verse_num not in verse_numbers %}
                                            {% set _ = verse_numbers.append(verse_num) %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% set actual_verse_count = verse_numbers|length %}
                            {% for verse in verses %}
                                {% if verse.strip() %}
                                    <section data-transition="none" {% if song.background_image %}data-background="{{ url_for('serve_dist_file', filename=song.background_image.replace("dist/", "")) }}"{% endif %}>
                                        <h2>{% if song.hymn_number %}{% set hymn_info = get_hymn_info(song.hymn_number) %}{{ song.hymn_number }}Ïû•<a>(ÏÉà{{ hymn_info.newHymnNumber if hymn_info and hymn_info.newHymnNumber else song.hymn_number }})</a>{% endif %}. {{ song.title }}</h2>
                                        <div class="imageblock">
                                            <p>
                                                {% set clean_verse = verse.strip() %}
                                                {% set verse_lines = clean_verse.split('\n') %}
                                                {% if verse_lines[0] and ('Ï†à' in verse_lines[0] or 'ÌõÑÎ†¥' in verse_lines[0]) %}
                                                    {{ verse_lines[0] }}<br/>
                                                    {% for line in verse_lines[1:] %}
                                                        {% if line.strip() %}
                                                            {{ line }}<br/>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {% for line in verse_lines %}
                                                        {% if line.strip() %}
                                                            {{ line }}<br/>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </p>
                                        </div>
                                        <h4>
                                            {% if verse_lines[0] and ('Ï†à' in verse_lines[0] or 'ÌõÑÎ†¥' in verse_lines[0]) %}
                                                {{ verse_lines[0] }}/{{ actual_verse_count }}Ï†à
                                            {% else %}
                                                {{ song.hymn_number }}Ïû•
                                            {% endif %}
                                        </h4>
                                    </section>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </section>

                {% elif song.song_type == 'ccm' %}
                    <!-- CCM -->
                    <section id="{{ song.title }}">
                        {% if has_ccm_lyrics(song.title) %}
                            <!-- Í∞ÄÏÇ¨ Í∏∞Î∞ò CCM -->
                            {% set ccm_lyrics = get_ccm_lyrics(song.title) %}
                            {% if ccm_lyrics %}
                                {% set parsed_verses = parse_ccm_lyrics(ccm_lyrics) %}
                                {% set verse_keys = parsed_verses.keys() | list %}
                                {% set verse_count = verse_keys | length %}
                                
                                {% for verse_key, verse_data in parsed_verses.items() %}
                                    <section data-transition="none" {% if song.background_image %}data-background="{{ url_for('serve_dist_file', filename=song.background_image.replace("dist/", "")) }}"{% endif %}>
                                        <h2>{{ song.title }}</h2>
                                        <div class="imageblock">
                                            <p>
                                                {% if verse_data.verse_number == 'ÌõÑÎ†¥' %}
                                                    ÌõÑÎ†¥<br/>
                                                {% else %}
                                                    {{ verse_data.verse_number }}Ï†à<br/>
                                                {% endif %}
                                                {% for line in verse_data.text %}
                                                    {% if line.strip() %}
                                                        {{ line }}<br/>
                                                    {% endif %}
                                                {% endfor %}
                                            </p>
                                        </div>
                                        <h4>
                                            {% if verse_data.verse_number == 'ÌõÑÎ†¥' %}
                                                ÌõÑÎ†¥{% if verse_data.total_verses > 0 %}/{{ verse_data.total_verses }}Ï†à{% endif %}
                                            {% else %}
                                                {{ verse_data.verse_number }}Ï†à/{{ verse_data.total_verses }}Ï†à
                                            {% endif %}
                                        </h4>
                                    </section>
                                {% endfor %}
                            {% endif %}
                        {% else %}
                            <!-- Ïù¥ÎØ∏ÏßÄ Í∏∞Î∞ò CCM -->
                            {% set ccm_images = get_ccm_images(song.title) %}
                            {% for image in ccm_images %}
                                <section data-transition="none" {% if song.background_image %}data-background="{{ url_for('serve_dist_file', filename=song.background_image.replace("dist/", "")) }}"{% endif %}>
                                    <h2>{{ song.title }}</h2>
                                    <div class="imageblock">
                                        <img class="cropped" src="{{ url_for('serve_ccm_image', song_title=song.title, filename=image.filename) }}" style="object-position: 0 0%; width: 100%;" />
                                    </div>
                                    <h4>{{ loop.index }}Ïû•/{{ ccm_images|length }}Ïû•</h4>
                                </section>
                            {% endfor %}
                        {% endif %}
                    </section>
                {% endif %}

                <!-- ÏÑπÏÖò ÏÇ¨Ïù¥Ïùò Î∞∞Í≤Ω Ïä¨ÎùºÏù¥Îìú (ÎØ∏ÎîîÏñ¥Îäî Ï†úÏô∏) -->
                {% if song.song_type == 'section' and not loop.last %}
                    {% set next_song = post.songs[loop.index0 + 1] if loop.index0 + 1 < post.songs|length else none %}
                    {% if next_song and next_song.song_type == 'section' %}
                        <section {% if post.background_image %}data-background="{{ url_for('serve_dist_file', filename=post.background_image.replace("dist/", "")) }}"{% endif %} data-background-color="#222"></section>
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
    
    <script src="{{ url_for('serve_dist_file', filename='reveal.js') }}"></script>
    <script src="{{ url_for('serve_dist_file', filename='clock.js') }}"></script>
    <script>
        Reveal.initialize({
            width: 1280,
            height: 720,
            controls: true,
            progress: true,
            center: false,
            hash: true,
            navigationMode: "linear",
            {% if post.parallax_image %}
            parallaxBackgroundImage: "{{ url_for('serve_dist_file', filename=post.parallax_image.replace("dist/", "")) }}",
            parallaxBackgroundSize: "2688px 1280px",
            parallaxBackgroundHorizontal: 10,
            parallaxBackgroundVertical: 0,
            {% endif %}
            transition: "slide"
        });
        
        // ÎπÑÎîîÏò§ Ï†úÏñ¥ Ìï®ÏàòÎì§
        function toggleVideoSound(button) {
            const section = button.closest('section');
            const videoElement = section.closest('.reveal').querySelector('.slide-background.present video');
            
            if (videoElement) {
                if (videoElement.muted) {
                    videoElement.muted = false;
                    button.querySelector('.muted-icon').style.display = 'none';
                    button.querySelector('.unmuted-icon').style.display = 'inline';
                } else {
                    videoElement.muted = true;
                    button.querySelector('.muted-icon').style.display = 'inline';
                    button.querySelector('.unmuted-icon').style.display = 'none';
                }
            }
        }
        
        function toggleVideoPlay(button) {
            const section = button.closest('section');
            const videoElement = section.closest('.reveal').querySelector('.slide-background.present video');
            
            if (videoElement) {
                if (videoElement.paused) {
                    videoElement.play();
                    button.querySelector('.play-icon').style.display = 'inline';
                    button.querySelector('.pause-icon').style.display = 'none';
                } else {
                    videoElement.pause();
                    button.querySelector('.play-icon').style.display = 'none';
                    button.querySelector('.pause-icon').style.display = 'inline';
                }
            }
        }
        
        // Í∏¥ Ï†úÎ™©Ïóê ÎåÄÌïú Ìè∞Ìä∏ ÌÅ¨Í∏∞ ÏûêÎèô Ï°∞Ï†ï Ìï®Ïàò
        function adjustTitleFontSize() {
            // ÌÖåÏù¥Î∏îÏùò ÏÑ∏ Î≤àÏß∏ Ïó¥(Ï†úÎ™© Ïó¥)Ïùò Î™®Îì† ÏÖÄÏùÑ Ï∞æÍ∏∞
            const titleCells = document.querySelectorAll('.reveal table th:nth-child(3), .reveal table td:nth-child(3)');
            
            titleCells.forEach(cell => {
                const text = cell.textContent.trim();
                const textLength = text.length;
                
                // Í∏∞Ï°¥ ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
                cell.classList.remove('medium-title', 'long-title');
                
                // ÌÖçÏä§Ìä∏ Í∏∏Ïù¥Ïóê Îî∞Îùº ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
                if (textLength >= 18 && textLength < 25) {
                    cell.classList.add('medium-title');
                } else if (textLength >= 25) {
                    cell.classList.add('long-title');
                }
            });
        }
        
        // Ïä¨ÎùºÏù¥Îìú Î≥ÄÍ≤Ω Ïãú ÎπÑÎîîÏò§ Ïª®Ìä∏Î°§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ï†úÎ™© Ìè∞Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
        Reveal.addEventListener('slidechanged', function(event) {
            const currentSlide = event.currentSlide;
            const videoControls = currentSlide.querySelector('.video-controls');
            
            // Ï†úÎ™© Ìè∞Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
            adjustTitleFontSize();
            
            if (videoControls) {
                setTimeout(() => {
                    const videoElement = document.querySelector('.slide-background.present video');
                    if (videoElement) {
                        // ÏÜåÎ¶¨ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        const soundBtn = videoControls.querySelector('button[onclick*="toggleVideoSound"]');
                        if (soundBtn) {
                            if (videoElement.muted) {
                                soundBtn.querySelector('.muted-icon').style.display = 'inline';
                                soundBtn.querySelector('.unmuted-icon').style.display = 'none';
                            } else {
                                soundBtn.querySelector('.muted-icon').style.display = 'none';
                                soundBtn.querySelector('.unmuted-icon').style.display = 'inline';
                            }
                        }
                        
                        // Ïû¨ÏÉù Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                        const playBtn = videoControls.querySelector('button[onclick*="toggleVideoPlay"]');
                        if (playBtn) {
                            if (videoElement.paused) {
                                playBtn.querySelector('.play-icon').style.display = 'none';
                                playBtn.querySelector('.pause-icon').style.display = 'inline';
                            } else {
                                playBtn.querySelector('.play-icon').style.display = 'inline';
                                playBtn.querySelector('.pause-icon').style.display = 'none';
                            }
                        }
                    }
                }, 100);
            }
        });
        
        // Ï¥àÍ∏∞ Î°úÎî© ÏãúÏóêÎèÑ Ï†úÎ™© Ìè∞Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
        Reveal.addEventListener('ready', function(event) {
            adjustTitleFontSize();
        });
    </script>
</body>
</html>