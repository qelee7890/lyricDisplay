@echo off
@chcp 65001 1> NUL 2> NUL
title ?? ?? ?????? ??

echo ========================================================
echo  ?? ?? ?????? ??
echo ========================================================
echo.

:: 1. Git ?? ??
git --version >NUL 2>&1
if errorlevel 1 (
    echo [??] Git? ???? ?? ????.
    echo Git? ?? ??????: https://git-scm.com/downloads
    echo.
    pause
    exit /b 1
)
echo [OK] Git ?? ???.

:: 2. Python ?? ??
python --version >NUL 2>&1
if errorlevel 1 (
    echo [??] Python? PATH ????? ???? ?? ????.
    echo.
    echo ========================================================
    echo  ??? ??? ?? ??:
    echo ========================================================
    echo.
    echo 1. Python? ???? ??? PATH? ???? ??
    echo    ??: Python? ?? ????? "Add Python to PATH" ??
    echo.
    echo 2. Microsoft Store Python? ??
    echo    ??: ?? ^> ? ^> ? ?? ????
    echo          "? ?? ??? python.exe" ??
    echo.
    echo 3. Python? ???? ?? ??
    echo    ??: Python 3.9-3.11 ?? ?? ??
    echo          https://www.python.org/downloads/
    echo.
    echo ========================================================
    echo.
    pause
    exit /b 1
)
echo [OK] Python ?? ???.
python --version

:: 3. ???? ?? ?? (????)
if exist ".git" (
    echo.
    echo ?? ??? ???????????
    echo [??] ?? ????? ?? ?????.
    echo.
    choice /C YN /M "????? ????????"
    if errorlevel 2 (
        echo ????? ?????.
    ) else (
        echo.
        echo [???? ??] ?? ??? ??????...
        git fetch origin main
        git checkout main
        git reset --hard origin/main
        git clean -fd
        echo [??] ???? ??. ????? ?? ?????...
        echo.
        pause
        start "" "%~f0"
        exit
    )
)

:: 4. ?? ??? ??
echo.
echo [??] Python ????? ?? ?...
pip install -q Flask==2.3.3 Flask-SQLAlchemy==3.0.5 Werkzeug==2.3.7
if errorlevel 1 (
    echo [??] ?? ??? ??? ???? ? ????.
    echo ??? ??? ????? ???? ??????:
    echo   pip install Flask Flask-SQLAlchemy Werkzeug
    echo.
    pause
) else (
    echo [OK] ??? ?? ??
)

:: 5. ?? ???? ??
if not exist "dist" mkdir dist
if not exist "dist\hymn" mkdir dist\hymn
if not exist "dist\ccm" mkdir dist\ccm
if not exist "dist\media" mkdir dist\media

:: 6. ? ??
echo.
echo ========================================================
echo  ??? ?????.
echo  ?????? http://127.0.0.1:5001 ? ???.
echo ========================================================
echo.
echo ? ??: ? ??? [Ctrl + C] ???
echo.

:: 5? ? ???? ?? ??
start /B timeout /t 5 /nobreak >NUL && start http://127.0.0.1:5001

:: Flask ?? (?? ?? ??)
python app.py
set EXIT_CODE=%errorlevel%

echo.
if %EXIT_CODE% neq 0 (
    echo ========================================================
    echo [??] ?????? ?? ? ??? ??????.
    echo ?? ??: %EXIT_CODE%
    echo ========================================================
    echo.
    echo ??? ??:
    echo - ?? 5001? ?? ?? ?? ? ????
    echo - Python ????? ??? ???? ? ????
    echo - app.py ??? ??? ?? ? ????
    echo.
) else (
    echo ?? ????? ???????.
)
pause
